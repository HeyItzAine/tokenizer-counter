<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Token Counter</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .animate-pulse-custom {
            animation: pulse-custom 0.6s ease-in-out;
        }
        
        @keyframes pulse-custom {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .token-hover:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-border {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899);
            padding: 2px;
            border-radius: 12px;
        }
        
        .gradient-border-inner {
            background: white;
            border-radius: 10px;
        }
        
        .dark .gradient-border-inner {
            background: rgb(31, 41, 55);
        }
        
        .typing-indicator {
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .model-selector {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .cost-display {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .tooltip {
            position: relative;
        }
        
        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 100;
        }
        
        .tooltip:hover::before {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800 min-h-screen transition-all duration-300">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="gradient-border mb-8">
            <div class="gradient-border-inner p-6 text-center relative">
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200">
                    <svg id="sun-icon" class="w-6 h-6 text-yellow-500 hidden dark:block" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                    </svg>
                    <svg id="moon-icon" class="w-6 h-6 text-gray-600 block dark:hidden" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>
                
                <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
                    Enhanced Token Counter
                </h1>
                <p class="text-gray-600 dark:text-gray-300">
                    Advanced tokenization with AI model comparison and cost estimation
                </p>
            </div>
        </div>

        <!-- Model Selection -->
        <div class="model-selector rounded-xl p-4 mb-6 text-white">
            <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Select AI Model
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="gpt-4.1" class="hidden peer" checked>
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">GPT-4.1</div>
                        <div class="text-sm opacity-80">$2.00/1M tokens</div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="gpt-4.1-mini" class="hidden peer">
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">GPT-4.1 mini</div>
                        <div class="text-sm opacity-80">$0.40/1M tokens</div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="gpt-4.1-nano" class="hidden peer">
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">GPT-4.1 nano</div>
                        <div class="text-sm opacity-80">$0.10/1M tokens</div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="gpt-4o" class="hidden peer">
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">GPT-4o</div>
                        <div class="text-sm opacity-80">$5.00/1M tokens</div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="gpt-4o-mini" class="hidden peer">
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">GPT-4o mini</div>
                        <div class="text-sm opacity-80">$0.15/1M tokens</div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="o3" class="hidden peer">
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">o3</div>
                        <div class="text-sm opacity-80">$2.00/1M tokens</div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="o4-mini" class="hidden peer">
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">o4-mini</div>
                        <div class="text-sm opacity-80">$1.10/1M tokens</div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="gemini-2.5-pro" class="hidden peer">
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">Gemini 2.5 Pro</div>
                        <div class="text-sm opacity-80">$1.25/1M tokens</div>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" name="model" value="gemini-2.5-flash" class="hidden peer">
                    <div class="p-3 rounded-lg border-2 border-white/30 peer-checked:border-white peer-checked:bg-white/20 transition-all">
                        <div class="font-medium">Gemini 2.5 Flash</div>
                        <div class="text-sm opacity-80">$0.30/1M tokens</div>
                    </div>
                </label>
            </div>
        </div>

        <!-- Statistics Dashboard -->
        <div class="comparison-grid mb-6">
            <div class="glass-effect rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mb-2" id="token-count">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Estimated Tokens</div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-2" id="word-count">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Words</div>
            </div>
            
            <div class="glass-effect rounded-xl p-6 text-center">
                <div class="text-3xl font-bold text-purple-600 dark:text-purple-400 mb-2" id="char-count">0</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">Characters</div>
            </div>
            
            <div class="cost-display rounded-xl p-6 text-center text-white">
                <div class="text-3xl font-bold mb-2" id="estimated-cost">$0.00</div>
                <div class="text-sm opacity-80">Estimated Cost</div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Text Input -->
            <div class="glass-effect rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Text Input</h3>
                    <div class="flex gap-2">
                        <button id="paste-btn" class="tooltip px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm" data-tooltip="Paste from clipboard">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8 2a1 1 0 000 2h2a1 1 0 100-2H8z"/>
                                <path d="M3 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v6h-4.586l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L10.414 13H15v3a2 2 0 01-2 2H5a2 2 0 01-2-2V5z"/>
                            </svg>
                        </button>
                        <button id="clear-btn" class="tooltip px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm" data-tooltip="Clear all">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <textarea 
                    id="text-input" 
                    rows="10"
                    class="w-full p-4 bg-white/50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-none text-gray-800 dark:text-gray-200"
                    placeholder="Type or paste your text here..."
                ></textarea>
                <div class="flex justify-between items-center mt-2 text-sm text-gray-500 dark:text-gray-400">
                    <span>Real-time analysis</span>
                    <span class="typing-indicator" id="typing-indicator" style="display: none;">Analyzing...</span>
                </div>
            </div>

            <!-- File Upload -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">File Upload</h3>
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-blue-500 transition-colors duration-200" id="drop-zone">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">Drop files here or click to browse</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">Supports: .txt, .md, .json, .js, .py, .html, .css</p>
                    <input type="file" id="file-input" class="hidden" accept=".txt,.md,.json,.js,.py,.html,.css,.csv,.xml">
                </div>
                <div id="file-info" class="mt-4 text-sm text-gray-600 dark:text-gray-400" style="display: none;">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                        </svg>
                        <span id="file-name"></span>
                        <span id="file-size" class="text-gray-500"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Token Visualization -->
        <div class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Token Visualization</h3>
                <div class="flex gap-2">
                    <button id="toggle-colors" class="tooltip px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm" data-tooltip="Toggle color coding">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v11a3 3 0 106 0V4a2 2 0 00-2-2H4zm1 14a1 1 0 100-2 1 1 0 000 2zm5-1.757l4.9-4.9a2 2 0 000-2.828L13.485 5.1a2 2 0 00-2.828 0L10 5.757v8.486zM16 18H9.071l6-6H16a2 2 0 012 2v2a2 2 0 01-2 2z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <button id="export-tokens" class="tooltip px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm" data-tooltip="Export token analysis">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="token-preview" class="min-h-[200px] p-4 bg-white/30 dark:bg-gray-800/30 rounded-lg border border-gray-200 dark:border-gray-700 overflow-auto">
                <div class="text-gray-500 dark:text-gray-400 text-center py-8">
                    Enter text to see token visualization
                </div>
            </div>
        </div>

        <!-- Advanced Analytics -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Text Statistics -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Text Statistics</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Sentences:</span>
                        <span id="sentence-count" class="font-medium text-gray-800 dark:text-gray-200">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Paragraphs:</span>
                        <span id="paragraph-count" class="font-medium text-gray-800 dark:text-gray-200">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Avg. Words/Sentence:</span>
                        <span id="avg-words" class="font-medium text-gray-800 dark:text-gray-200">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Reading Time:</span>
                        <span id="reading-time" class="font-medium text-gray-800 dark:text-gray-200">0 min</span>
                    </div>
                </div>
            </div>

            <!-- Token Efficiency -->
            <div class="glass-effect rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Token Efficiency</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Chars/Token:</span>
                        <span id="chars-per-token" class="font-medium text-gray-800 dark:text-gray-200">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Words/Token:</span>
                        <span id="words-per-token" class="font-medium text-gray-800 dark:text-gray-200">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Compression Ratio:</span>
                        <span id="compression-ratio" class="font-medium text-gray-800 dark:text-gray-200">0%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Whitespace:</span>
                        <span id="whitespace-ratio" class="font-medium text-gray-800 dark:text-gray-200">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center mt-8 text-gray-500 dark:text-gray-400 text-sm">
            <p>Token counts are estimates based on common tokenization patterns. Actual counts may vary by model.</p>
        </div>
    </div>

    <script>
        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;
        
        // Initialize theme
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            html.classList.add('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Enhanced tokenization
        function enhancedTokenize(text) {
            if (!text.trim()) return [];
            
            // More sophisticated regex for better tokenization
            const tokenRegex = /'(?:[sdmt]|ll|ve|re)|[^\r\n\p{L}\p{N}]?\p{L}+|\p{N}{2,}|[^\r\n\p{L}\p{N}]+|[\r\n]/gu;
            
            const tokens = [];
            let match;
            
            while ((match = tokenRegex.exec(text)) !== null) {
                tokens.push(match[0]);
            }
            
            return tokens;
        }

        // Color palette for tokens
        const tokenColors = [
            'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200',
            'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-200',
            'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-200',
            'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-200',
            'bg-pink-100 text-pink-800 dark:bg-pink-900/50 dark:text-pink-200',
            'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-200',
            'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-200',
            'bg-teal-100 text-teal-800 dark:bg-teal-900/50 dark:text-teal-200'
        ];

        // Model pricing
        const modelPricing = {
            'gpt-4.1': 0.002,           // $2.00/1M
            'gpt-4.1-mini': 0.0004,     // $0.40/1M
            'gpt-4.1-nano': 0.0001,     // $0.10/1M
            'gpt-4o': 0.005,            // $5.00/1M
            'gpt-4o-mini': 0.00015,     // $0.15/1M
            'o3': 0.002,                // $2.00/1M
            'o4-mini': 0.0011,          // $1.10/1M
            'gemini-2.5-pro': 0.00125,  // $1.25/1M
            'gemini-2.5-flash': 0.0003   // $0.30/1M
        };

        // State
        let currentText = '';
        let currentTokens = [];
        let showColors = true;
        let selectedModel = 'gpt-3.5';

        // DOM elements
        const textInput = document.getElementById('text-input');
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const fileInfo = document.getElementById('file-info');
        const tokenPreview = document.getElementById('token-preview');
        const typingIndicator = document.getElementById('typing-indicator');

        // Statistics elements
        const tokenCount = document.getElementById('token-count');
        const wordCount = document.getElementById('word-count');
        const charCount = document.getElementById('char-count');
        const estimatedCost = document.getElementById('estimated-cost');
        const sentenceCount = document.getElementById('sentence-count');
        const paragraphCount = document.getElementById('paragraph-count');
        const avgWords = document.getElementById('avg-words');
        const readingTime = document.getElementById('reading-time');
        const charsPerToken = document.getElementById('chars-per-token');
        const wordsPerToken = document.getElementById('words-per-token');
        const compressionRatio = document.getElementById('compression-ratio');
        const whitespaceRatio = document.getElementById('whitespace-ratio');

        // Update statistics
        function updateStatistics(text, tokens) {
            const chars = text.length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const sentences = text.trim() ? text.split(/[.!?]+/).filter(s => s.trim().length > 0).length : 0;
            const paragraphs = text.trim() ? text.split(/\n\s*\n/).filter(p => p.trim().length > 0).length : 0;
            const tokensLength = tokens.length;
            
            // Update counters with animation
            function animateCounter(element, newValue, suffix = '') {
                element.classList.add('animate-pulse-custom');
                setTimeout(() => {
                    element.textContent = newValue + suffix;
                    element.classList.remove('animate-pulse-custom');
                }, 100);
            }
            
            animateCounter(tokenCount, tokensLength);
            animateCounter(wordCount, words);
            animateCounter(charCount, chars);
            animateCounter(sentenceCount, sentences);
            animateCounter(paragraphCount, paragraphs);
            animateCounter(avgWords, sentences > 0 ? Math.round(words / sentences * 10) / 10 : 0);
            animateCounter(readingTime, Math.ceil(words / 200), ' min');
            
            // Efficiency metrics
            animateCounter(charsPerToken, tokensLength > 0 ? Math.round(chars / tokensLength * 100) / 100 : 0);
            animateCounter(wordsPerToken, tokensLength > 0 ? Math.round(words / tokensLength * 100) / 100 : 0);
            animateCounter(compressionRatio, chars > 0 ? Math.round((1 - tokensLength / chars) * 100) : 0, '%');
            
            const whitespaceChars = (text.match(/\s/g) || []).length;
            animateCounter(whitespaceRatio, chars > 0 ? Math.round(whitespaceChars / chars * 100) : 0, '%');
            
            // Cost calculation
            const cost = (tokensLength / 1000) * modelPricing[selectedModel];
            animateCounter(estimatedCost, '$' + cost.toFixed(4));
        }

        // Render token preview
        function renderTokenPreview(tokens) {
            if (tokens.length === 0) {
                tokenPreview.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-8">Enter text to see token visualization</div>';
                return;
            }
            
            const tokenElements = tokens.map((token, index) => {
                const colorClass = showColors ? tokenColors[index % tokenColors.length] : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
                const displayToken = token.replace(/\n/g, '\\n').replace(/\t/g, '\\t');
                return `<span class="inline-block px-2 py-1 m-1 rounded-md text-sm font-mono transition-transform duration-200 token-hover cursor-pointer ${colorClass}" title="Token ${index + 1}: '${token}'">${displayToken}</span>`;
            }).join('');
            
            tokenPreview.innerHTML = tokenElements;
        }

        // Process text
        function processText(text) {
            currentText = text;
            currentTokens = enhancedTokenize(text);
            
            // Show typing indicator
            typingIndicator.style.display = 'inline';
            
            // Simulate processing delay for better UX
            setTimeout(() => {
                updateStatistics(text, currentTokens);
                renderTokenPreview(currentTokens);
                typingIndicator.style.display = 'none';
            }, 200);
        }

        // Event listeners
        textInput.addEventListener('input', (e) => {
            processText(e.target.value);
        });

        // Model selection
        document.querySelectorAll('input[name="model"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedModel = e.target.value;
                updateStatistics(currentText, currentTokens);
            });
        });

        // File handling
        fileInput.addEventListener('change', handleFileSelect);
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                textInput.value = content;
                processText(content);
                
                // Show file info
                fileInfo.style.display = 'block';
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-size').textContent = `(${formatFileSize(file.size)})`;
            };
            reader.readAsText(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Utility buttons
        document.getElementById('paste-btn').addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                textInput.value = text;
                processText(text);
            } catch (err) {
                console.error('Failed to read clipboard:', err);
            }
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            textInput.value = '';
            fileInput.value = '';
            fileInfo.style.display = 'none';
            processText('');
        });

        document.getElementById('toggle-colors').addEventListener('click', () => {
            showColors = !showColors;
            renderTokenPreview(currentTokens);
        });

        document.getElementById('export-tokens').addEventListener('click', () => {
            const data = {
                text: currentText,
                tokens: currentTokens,
                statistics: {
                    tokenCount: currentTokens.length,
                    wordCount: currentText.trim() ? currentText.trim().split(/\s+/).length : 0,
                    charCount: currentText.length,
                    model: selectedModel,
                    estimatedCost: (currentTokens.length / 1000) * modelPricing[selectedModel]
                },
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'token-analysis.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'v':
                        if (e.target !== textInput) {
                            e.preventDefault();
                            document.getElementById('paste-btn').click();
                        }
                        break;
                    case 'k':
                        e.preventDefault();
                        document.getElementById('clear-btn').click();
                        break;
                    case 'e':
                        e.preventDefault();
                        document.getElementById('export-tokens').click();
                        break;
                    case 'd':
                        e.preventDefault();
                        themeToggle.click();
                        break;
                }
            }
        });

        // Initialize
        processText('');
        
        // Add some sample text for demonstration
        const sampleText = `Welcome to the Enhanced Token Counter! This tool provides advanced tokenization analysis for various AI models. 

Features include:
- Real-time token counting and visualization
- Support for multiple AI models (GPT-4, GPT-3.5, Claude, Gemini)
- Cost estimation based on current pricing
- Detailed text statistics and efficiency metrics
- File upload support for various formats
- Dark/light theme toggle
- Export functionality for analysis results

Try typing some text or uploading a file to see the tokenization in action!`;

        // Uncomment the line below to show sample text on load
        // textInput.value = sampleText;
        // processText(sampleText);

        // Add touch support for mobile
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchmove', (e) => {
            const touchY = e.touches[0].clientY;
            const deltaY = touchStartY - touchY;
            
            if (deltaY > 50 && window.scrollY === 0) {
                // Pull down to refresh gesture
                location.reload();
            }
        });

        // Progressive Web App features
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {
                    // Service worker registration failed - this is fine for local usage
                });
            });
        }

        // Auto-save feature
        let autoSaveTimeout;
        textInput.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                localStorage.setItem('tokenizer-autosave', textInput.value);
            }, 1000);
        });

        // Load auto-saved content
        const autoSavedContent = localStorage.getItem('tokenizer-autosave');
        if (autoSavedContent && autoSavedContent.trim()) {
            textInput.value = autoSavedContent;
            processText(autoSavedContent);
        }

        // Performance monitoring
        let lastProcessTime = 0;
        const originalProcessText = processText;
        processText = function(text) {
            const startTime = performance.now();
            originalProcessText(text);
            lastProcessTime = performance.now() - startTime;
            
            // Log performance if processing takes too long
            if (lastProcessTime > 100) {
                console.log(`Token processing took ${lastProcessTime.toFixed(2)}ms for ${text.length} characters`);
            }
        };

        // Add resize observer for responsive token preview
        if (window.ResizeObserver) {
            const resizeObserver = new ResizeObserver(() => {
                if (currentTokens.length > 0) {
                    renderTokenPreview(currentTokens);
                }
            });
            resizeObserver.observe(tokenPreview);
        }

        // Add focus management
        textInput.addEventListener('focus', () => {
            document.body.classList.add('input-focused');
        });
        
        textInput.addEventListener('blur', () => {
            document.body.classList.remove('input-focused');
        });

        // Add word highlighting on token hover
        tokenPreview.addEventListener('mouseover', (e) => {
            if (e.target.classList.contains('token-hover')) {
                e.target.style.transform = 'scale(1.1)';
                e.target.style.zIndex = '10';
            }
        });
        
        tokenPreview.addEventListener('mouseout', (e) => {
            if (e.target.classList.contains('token-hover')) {
                e.target.style.transform = 'scale(1)';
                e.target.style.zIndex = '1';
            }
        });

        // Add copy token functionality
        tokenPreview.addEventListener('click', (e) => {
            if (e.target.classList.contains('token-hover')) {
                const tokenText = e.target.textContent;
                navigator.clipboard.writeText(tokenText).then(() => {
                    // Show temporary feedback
                    const originalText = e.target.textContent;
                    e.target.textContent = 'Copied!';
                    e.target.classList.add('bg-green-200', 'text-green-800');
                    setTimeout(() => {
                        e.target.textContent = originalText;
                        e.target.classList.remove('bg-green-200', 'text-green-800');
                    }, 1000);
                });
            }
        });

        // Add analytics tracking (privacy-friendly)
        const analytics = {
            textProcessed: 0,
            filesUploaded: 0,
            tokensAnalyzed: 0,
            sessionStart: Date.now()
        };

        const originalProcessTextWithAnalytics = processText;
        processText = function(text) {
            analytics.textProcessed++;
            analytics.tokensAnalyzed += enhancedTokenize(text).length;
            originalProcessTextWithAnalytics(text);
        };

        const originalHandleFile = handleFile;
        handleFile = function(file) {
            analytics.filesUploaded++;
            originalHandleFile(file);
        };

        // Show session stats on page unload (for development)
        window.addEventListener('beforeunload', () => {
            const sessionDuration = Date.now() - analytics.sessionStart;
            console.log('Session Analytics:', {
                ...analytics,
                sessionDuration: `${Math.round(sessionDuration / 1000)}s`
            });
        });

        // Add easter egg
        let konamiCode = [];
        const konamiSequence = [38, 38, 40, 40, 37, 39, 37, 39, 66, 65]; // Up, Up, Down, Down, Left, Right, Left, Right, B, A
        
        document.addEventListener('keydown', (e) => {
            konamiCode.push(e.keyCode);
            if (konamiCode.length > konamiSequence.length) {
                konamiCode.shift();
            }
            
            if (konamiCode.length === konamiSequence.length && 
                konamiCode.every((code, index) => code === konamiSequence[index])) {
                // Easter egg activated
                document.body.style.animation = 'rainbow 2s infinite';
                setTimeout(() => {
                    document.body.style.animation = '';
                }, 5000);
            }
        });

        // Add rainbow animation for easter egg
        const style = document.createElement('style');
        style.textContent = `
            @keyframes rainbow {
                0% { filter: hue-rotate(0deg); }
                100% { filter: hue-rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
